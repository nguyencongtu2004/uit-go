# Traefik Configuration for UIT-Go Microservices
# Main configuration file for Traefik v3 reverse proxy

# Global Configuration
global:
  checkNewVersion: false
  sendAnonymousUsage: false

# API and Dashboard
api:
  dashboard: true
  insecure: true # Enable for development - disable in production
  debug: true

# Entry Points Configuration
entryPoints:
  web:
    address: ":80"
    # HTTP redirect to HTTPS in production
    # http:
    #   redirections:
    #     entrypoint:
    #       to: websecure
    #       scheme: https

  websecure:
    address: ":443"
    # HTTP/2 and HTTP/3 support
    http2:
      maxConcurrentStreams: 250
    http3: {}

  traefik:
    address: ":8080"

# Providers Configuration
providers:
  # Docker provider for automatic service discovery
  docker:
    endpoint: "unix:///var/run/docker.sock"
    exposedByDefault: false
    network: "uit-go_uit-go-network" # Use the actual Docker Compose network name
    watch: true
    defaultRule: "Host(`{{ normalize .Name }}.localhost`)"

  # File provider for static configuration and middleware
  file:
    filename: /etc/traefik/dynamic.yml
    watch: true

# Certificate Resolvers (for production SSL)
certificatesResolvers:
  letsencrypt:
    acme:
      email: admin@uit-go.local
      storage: /etc/traefik/acme.json
      httpChallenge:
        entryPoint: web
      # Alternative: DNS challenge for wildcard certificates
      # dnsChallenge:
      #   provider: cloudflare
      #   delayBeforeCheck: 0

# Logging Configuration
log:
  level: INFO
  format: json
  filePath: "/var/log/traefik/traefik.log"

# Access Logs
accessLog:
  format: json
  filePath: "/var/log/traefik/access.log"
  bufferingSize: 0
  filters:
    statusCodes:
      - "200"
      - "300-302"
      - "400-499"
      - "500-599"
    retryAttempts: true
    minDuration: "10ms"
  fields:
    defaultMode: keep
    names:
      ClientUsername: drop
    headers:
      defaultMode: keep
      names:
        User-Agent: redact
        Authorization: drop
        Content-Type: keep

# Metrics Configuration
metrics:
  prometheus:
    addEntryPointsLabels: true
    addServicesLabels: true
    addRoutersLabels: true
    buckets:
      - 0.1
      - 0.3
      - 1.2
      - 5.0

# Health Check Configuration
ping:
  entryPoint: traefik