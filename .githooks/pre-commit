#!/bin/sh
# Pre-commit hook for UIT-Go project
# This hook runs before each commit to ensure code quality

echo "ğŸ” Running pre-commit checks..."

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Flag to track if any checks fail
CHECKS_FAILED=0

# Function to print status
print_status() {
    if [ $1 -eq 0 ]; then
        echo "${GREEN}âœ… $2${NC}"
    else
        echo "${RED}âŒ $2${NC}"
        CHECKS_FAILED=1
    fi
}

# Check if package.json files have changed and run npm install if needed
echo "${YELLOW}ğŸ“¦ Checking for package.json changes...${NC}"
if git diff --cached --name-only | grep -E "package\.json$" > /dev/null; then
    echo "ğŸ“¦ package.json changes detected, ensuring dependencies are up to date..."
    
    # Check root package.json
    if [ -f package.json ] && git diff --cached --name-only | grep -E "^package\.json$" > /dev/null; then
        npm install > /dev/null 2>&1
        print_status $? "Root dependencies updated"
    fi
    
    # Check service package.json files
    for service_dir in services/*/; do
        if [ -f "${service_dir}package.json" ] && git diff --cached --name-only | grep -E "^${service_dir}package\.json$" > /dev/null; then
            cd "$service_dir" && npm install > /dev/null 2>&1
            print_status $? "Dependencies updated for $(basename "$service_dir")"
            cd - > /dev/null
        fi
    done
fi

# Lint JavaScript files
echo "${YELLOW}ğŸ” Running ESLint...${NC}"
JS_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(js|jsx)$')
if [ -n "$JS_FILES" ]; then
    echo "$JS_FILES" | xargs npx eslint --fix
    LINT_EXIT_CODE=$?
    
    if [ $LINT_EXIT_CODE -eq 0 ]; then
        # Re-add files that were fixed by eslint --fix
        echo "$JS_FILES" | xargs git add
    fi
    
    print_status $LINT_EXIT_CODE "ESLint checks"
else
    echo "${GREEN}âœ… No JavaScript files to lint${NC}"
fi

# Check for sensitive files
echo "${YELLOW}ğŸ” Checking for sensitive files...${NC}"
SENSITIVE_FILES=$(git diff --cached --name-only | grep -E '\.(env|key|pem|p12|pfx)$' | grep -v '\.env\.template$')
if [ -n "$SENSITIVE_FILES" ]; then
    echo "${RED}âŒ Sensitive files detected:${NC}"
    echo "$SENSITIVE_FILES"
    echo "${RED}Please remove sensitive files from commit or add them to .gitignore${NC}"
    CHECKS_FAILED=1
else
    print_status 0 "No sensitive files detected"
fi

# Check for large files
echo "${YELLOW}ğŸ“ Checking for large files...${NC}"
LARGE_FILES=$(git diff --cached --name-only | xargs -I {} sh -c 'if [ -f "{}" ] && [ $(stat -f%z "{}" 2>/dev/null || stat -c%s "{}" 2>/dev/null || echo 0) -gt 1048576 ]; then echo "{}"; fi')
if [ -n "$LARGE_FILES" ]; then
    echo "${RED}âŒ Large files detected (>1MB):${NC}"
    echo "$LARGE_FILES"
    echo "${YELLOW}Consider using Git LFS for large files${NC}"
    CHECKS_FAILED=1
else
    print_status 0 "No large files detected"
fi

# Check Docker files
echo "${YELLOW}ğŸ³ Validating Docker files...${NC}"
DOCKER_FILES=$(git diff --cached --name-only | grep -E '^(Dockerfile|docker-compose\.ya?ml)$')
if [ -n "$DOCKER_FILES" ]; then
    # Basic validation for Dockerfile
    if echo "$DOCKER_FILES" | grep -q "Dockerfile"; then
        for dockerfile in $DOCKER_FILES; do
            if [[ "$dockerfile" == *"Dockerfile"* ]]; then
                # Check if FROM instruction exists
                if ! grep -q "^FROM" "$dockerfile"; then
                    echo "${RED}âŒ $dockerfile is missing FROM instruction${NC}"
                    CHECKS_FAILED=1
                fi
                # Check if WORKDIR is set
                if ! grep -q "^WORKDIR" "$dockerfile"; then
                    echo "${YELLOW}âš ï¸ $dockerfile might be missing WORKDIR instruction${NC}"
                fi
            fi
        done
    fi
    
    # Validate docker-compose files
    if echo "$DOCKER_FILES" | grep -q "docker-compose"; then
        for compose_file in $DOCKER_FILES; do
            if [[ "$compose_file" == *"docker-compose"* ]]; then
                if command -v docker-compose > /dev/null 2>&1; then
                    docker-compose -f "$compose_file" config > /dev/null 2>&1
                    print_status $? "Docker Compose validation for $compose_file"
                fi
            fi
        done
    fi
else
    print_status 0 "No Docker files to validate"
fi

# Check for TODO/FIXME comments in staged files
echo "${YELLOW}ğŸ“ Checking for TODO/FIXME comments...${NC}"
TODO_COUNT=$(git diff --cached | grep -E '^\+.*\b(TODO|FIXME|HACK|XXX)\b' | wc -l | tr -d ' ')
if [ "$TODO_COUNT" -gt 0 ]; then
    echo "${YELLOW}âš ï¸ Found $TODO_COUNT new TODO/FIXME comments${NC}"
    git diff --cached | grep -E '^\+.*\b(TODO|FIXME|HACK|XXX)\b' | head -5
    if [ "$TODO_COUNT" -gt 5 ]; then
        echo "${YELLOW}... and $((TODO_COUNT - 5)) more${NC}"
    fi
    echo "${YELLOW}Consider addressing these before committing${NC}"
else
    print_status 0 "No new TODO/FIXME comments"
fi

# Format check for common files
echo "${YELLOW}ğŸ“ Checking file formatting...${NC}"
JSON_FILES=$(git diff --cached --name-only | grep -E '\.(json)$')
if [ -n "$JSON_FILES" ]; then
    for file in $JSON_FILES; do
        if ! python -m json.tool "$file" > /dev/null 2>&1 && ! node -e "JSON.parse(require('fs').readFileSync('$file'))" > /dev/null 2>&1; then
            echo "${RED}âŒ $file is not valid JSON${NC}"
            CHECKS_FAILED=1
        fi
    done
    if [ $CHECKS_FAILED -eq 0 ]; then
        print_status 0 "JSON files are valid"
    fi
fi

# Final status
echo ""
if [ $CHECKS_FAILED -eq 0 ]; then
    echo "${GREEN}âœ… All pre-commit checks passed!${NC}"
    echo "ğŸš€ Ready to commit"
    exit 0
else
    echo "${RED}âŒ Some pre-commit checks failed!${NC}"
    echo "ğŸ’¡ Please fix the issues above before committing"
    exit 1
fi